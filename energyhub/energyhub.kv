#:kivy 1.0

#:set non_eco (1, 0.5, 0, 1)
#:set inactive (0.7, 0.7, 0.7, 1)
#:set eco (0, 0.8, 0, 1)
#:set neutral (0, 0, 0, 1)

<BlackLabel@Label>
    color: (0, 0, 0, 1)

<PowerLabel@BlackLabel>
    val: 0
    unit: 'kW'
    unit_label: ('\n' if self.vertical else ' ' ) + f'[size={app.small_size}]{self.unit}[/size]'
    str_val: '%.*f' % (self.dp, self.val)
    text: f'{self.str_val}{self.unit_label}'
    dp: 2
    vertical: False
    markup: True
    halign: 'center'

<PercentLabel@PowerLabel>
    unit: '%'
    dp: 0

<Arrow>
    head_angle: 60
    main_color: (0, 0, 0, 1)
    outline_color: (1, 1, 1, 0)
    fletching_radius: 0
    arrow_at_midpoint: True

<PowerArrow@Arrow>
    power: 0
    active_color: neutral
    head_size: app.calculate_arrow_size(root.power)
    main_color: inactive if root.power == 0 else root.active_color

<LabeledArrow@PowerArrow>
    vertical: self.angle not in (0, 180)
    RelativeLayout:
        orientation: 'horizontal' if root.vertical else 'vertical'
        pos: (min(root.o_x, root.to_x), min(root.o_y, root.to_y))
        size: (root.parent.width*0.15, root.distance) if root.vertical else (root.distance, root.parent.height*0.05)

        PowerLabel:
            canvas:
                Color:
                    rgba: (0, 0, 0, 0)
                Rectangle:
                    pos: (self.x, self.y)
                    size: (self.width, self.height)
            val: root.power
            pos: (0, 0)
            halign: 'center'
            vertical: root.vertical
<Battery@Widget>
    canvas:
        Color:
            rgba: app.battery_color
        Rectangle:
            pos: (self.x, self.y)
            size: (self.width, self.height * 0.95 * app.battery_level/100)
        Color:
            rgb: 0, 0, 0
        Line:
            width: 4.
            rectangle: (self.x, self.y, self.width, self.height * .95)
        Line:
            width: 4.
            rectangle: (self.x+self.width*0.4, self.y+self.height*.95, self.width*0.2, self.height * .05)


<CurrentStatus@FloatLayout>:
    canvas.before:
        Color:
            rgb: 1, 1, 1
        Rectangle:
            pos: self.pos
            size: self.size
    IconButton:
        source: 'energyhub/resources/icons8-reset-48.png'
        text: 'Refresh'
        on_press: app.refresh()
        pos_hint: {'x': 0.86, 'y': 0.02}
        size_hint: (0.1, 0.1)
    Image:
        source: 'energyhub/resources/Solar_panel_icon.png'
        size_hint: (0.3, 0.1)
        allow_stretch: False
        pos_hint: {'x': 0.5 - ((self.width/self.parent.width) / 2), 'y': 0.88}
    PowerArrow:
        active_color: (0, 0.8, 0, 1)
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.9
        distance: self.parent.height * 0.1
        angle: 270
        power: app.solar_production
    PowerLabel:
        val: app.solar_production
        pos_hint: {'y': 0.925, 'x': 0.45}
        size_hint: (0.1, 0.1)
    LabeledArrow:
        power: app.battery_production
        active_color: eco
        o_x: self.parent.width * 0.3
        o_y: self.parent.height * 0.8
        distance: self.parent.width * 0.2
        angle: 0
        reverse_arrow: app.battery_state == 'Charging'
    Battery:
        size_hint: (0.122, 0.1)
        pos_hint: {'x': 0.16 - ((self.width/self.parent.width) / 2), 'y': 0.75}
    PercentLabel:
        val: app.battery_level
        pos_hint: {'y': 0.83, 'x': 0.15}
        size_hint: (0.05, 0.1)
    Image:
        source: 'energyhub/resources/pylon256.png'
        size_hint: (0.2, 0.2)
        pos_hint: {'x': 0.75, 'y': 0.7}
    LabeledArrow:
        power: app.grid_power
        reverse_arrow: app.grid_exporting
        active_color: eco if app.grid_exporting else non_eco
        o_x: self.parent.width * 0.7
        o_y: self.parent.height * 0.8
        distance: self.parent.width * 0.2
        angle: 180
    LabeledArrow:
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.8
        distance: self.parent.height * 0.1
        angle: 270
        power: app.solar_edge_load
    BlackLabel:
        text: f'{app.outside_temperature} ÂºC'
        size_hint: (0.1, 0.1)
        pos_hint: {'x': 0.65, 'y': 0.6}
        valign: 'middle'
    Image:
        source: 'energyhub/resources/radiator.jpg'
        size_hint: (0.35, 0.35)
        pos_hint: {'x': 0.001, 'y': 0.34}

    PowerArrow:
        # from House to first branches
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.6
        distance: self.parent.height * 0.1
        angle: 270
        power: app.solar_edge_load
    Image:
        source: 'energyhub/resources/shower.png'
        size_hint: (0.2, 0.2)
        pos_hint: {'x': 0.05, 'y': 0.3}
    LabeledArrow:
        # first left branch
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.5
        distance: self.parent.width * 0.2
        angle: 180
        power: app.heating_power
    Image:
        source: 'energyhub/resources/light-bulb-2-256.png'
        size_hint: (0.2, 0.2)
        pos_hint: {'x': 0.75, 'y': 0.42}
    LabeledArrow:
        # first right branch
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.5
        distance: self.parent.width * 0.2
        angle: 0
        power: app.remaining_load
    PowerArrow:
        # from first branches to second branches
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.5
        distance: self.parent.height * 0.1
        angle: 270
        power: app._bottom_arms_power
    LabeledArrow:
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.4
        distance: self.parent.width * 0.2
        angle: 180
        power: app.dhw_power
    LabeledArrow:
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.4
        distance: self.parent.width * 0.2
        angle: 0
        power: app.eddi_power
    Image:
        source: 'energyhub/resources/immersion-heater.png'
        size_hint: (0.2, 0.2)
        pos_hint: {'x': 0.75, 'y': 0.3}
    LabeledArrow:
        # to car load
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.4
        distance: self.parent.height * 0.1
        angle: 270
        power: app.zappi_power
    Image:
        source: 'energyhub/resources/ipace.jpg'
        size_hint: (0.5, 0.3)
        allow_stretch: False
        pos_hint: {'x': 0.25, 'y': 0.1}
    BlackLabel:
        text: app.car_charge_label
        pos_hint: {'y': 0.12, 'x': 0.45}
        size_hint: (0.1, 0.05)


CurrentStatus