#:import Arrow kivy_arrow.arrow.Arrow
#:import CurrentStatus energyhub.current_status.CurrentStatus
#:include energyhub/utils.kv

#:set non_eco (1, 0.5, 0, 1)
#:set inactive (0.7, 0.7, 0.7, 1)
#:set eco (0, 0.8, 0, 1)
#:set neutral (0, 0, 0, 1)

<EHLabel@Label>
    is_stale: None
    color: non_eco if self.is_stale is None else inactive if self.is_stale else neutral


<PowerLabel@EHLabel>
    val: 0
    unit: 'kW'
    conversion_factor: 1/1000
    unit_label: ('\n' if self.vertical else ' ' ) + f'[size={CurrentStatus.small_size()}]{self.unit}[/size]'
    str_val: '%.*f' % (self.dp, self.val*self.conversion_factor)
    text: f'{self.str_val}{self.unit_label}'
    dp: 2
    vertical: False
    markup: True
    halign: 'center'


<PercentLabel@PowerLabel>
    unit: '%'
    conversion_factor: 1
    dp: 0


<Arrow>
    head_angle: 60
    main_color: (0, 0, 0, 1)
    outline_color: (1, 1, 1, 0)
    fletching_radius: 0
    arrow_at_midpoint: True
    shaft_width: cm(0.03)


<PowerArrow@Arrow>
    power: 0
    active_color: neutral
    head_size: CurrentStatus.calculate_arrow_size(self.power)
    main_color: inactive if self.power == 0 else self.active_color


<LabeledArrow@PowerArrow>
    vertical: self.angle not in (0, 180)
    is_stale: None
    RelativeLayout:
        orientation: 'horizontal' if root.vertical else 'vertical'
        pos: (min(root.o_x, root.to_x), min(root.o_y, root.to_y))
        size: (root.parent.width*0.15, root.distance) if root.vertical else (root.distance, root.parent.height*0.05)
        PowerLabel:
            canvas:
                Color:
                    rgba: (0, 0, 0, 0)
                Rectangle:
                    pos: (self.x, self.y)
                    size: (self.width, self.height)
            val: root.power
            pos: (0, 0)
            halign: 'center'
            vertical: root.vertical
            is_stale: root.is_stale


<Battery@Widget>
    level: 0
    color: 0, 0, 0, 1
    canvas:
        Color:
            rgba: self.color
        Rectangle:
            pos: (self.x, self.y)
            size: (self.width, self.height * 0.95 * self.level/100)
        Color:
            rgb: 0, 0, 0
        Line:
            width: 4.
            rectangle: (self.x, self.y, self.width, self.height * .95)
        Line:
            width: 4.
            rectangle: (self.x+self.width*0.4, self.y+self.height*.95, self.width*0.2, self.height * .05)


<IconButtonRotatable>:
    angle: 0
    canvas.before:
        PushMatrix
        Rotate:
            angle: root.angle
            axis: 0, 0, 1
            origin: root.center
    canvas.after:
        PopMatrix

<CurrentStatus>:
    models: app.models
    canvas.before:
        Color:
            rgb: 1, 1, 1
        Rectangle:
            size: self.size
    IconButtonRotatable:
        source: 'energyhub/resources/icons8-reset-48.png'
        text: 'Refresh'
        on_press: root.refresh()
        pos_hint: {'x': 0.86, 'y': 0.02}
        size_hint: (0.08, 0.08)
        opacity: 0.5 if root.refreshing else 1
        disabled: root.refreshing
        rotating: root.refreshing
        allow_stretch: True
    Image:
        source: 'energyhub/resources/Solar_panel_icon.png'
        size_hint: (0.3, 0.1)
        allow_stretch: False
        pos_hint: {'x': 0.5 - ((self.width/self.parent.width) / 2), 'y': 0.88}
    PowerArrow:
        active_color: eco
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.9
        distance: self.parent.height * 0.1
        angle: 270
        power: root.models.solar.solar_production
    PowerLabel:
        val: root.models.solar.solar_production
        is_stale: root.models.solar.stale
        pos_hint: {'y': 0.925, 'x': 0.45}
        size_hint: (0.1, 0.1)
    LabeledArrow:
        is_stale: root.models.solar.stale
        power: root.models.solar.battery_production
        active_color: eco if root.models.solar.solar_production > 0 else non_eco
        o_x: self.parent.width * 0.3
        o_y: self.parent.height * 0.8
        distance: self.parent.width * 0.2
        angle: 0
        reverse_arrow: root.models.solar.battery_state == 'Charging'
    Battery:
        color: root.models.solar.battery_color
        level: root.models.solar.battery_level
        size_hint: (0.122, 0.1)
        pos_hint: {'x': 0.16 - ((self.width/self.parent.width) / 2), 'y': 0.75}
    PercentLabel:
        is_stale: root.models.solar.stale
        val: root.models.solar.battery_level
        pos_hint: {'y': 0.83, 'x': 0.15}
        size_hint: (0.05, 0.1)
    Image:
        source: 'energyhub/resources/pylon256.png'
        size_hint: (0.2, 0.2)
        pos_hint: {'x': 0.75, 'y': 0.7}
    LabeledArrow:
        is_stale: root.models.solar.stale
        power: root.models.solar.grid_power
        reverse_arrow: root.models.solar.grid_exporting
        active_color: eco if root.models.solar.grid_exporting else non_eco
        o_x: self.parent.width * 0.7
        o_y: self.parent.height * 0.8
        distance: self.parent.width * 0.2
        angle: 180
    LabeledArrow:
        active_color: root.models.solar.load_color
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.8
        distance: self.parent.height * 0.1
        angle: 270
        power: root.models.solar.load
        is_stale: root.models.solar.stale
    EHLabel:
        is_stale: root.models.heat_pump.stale
        text: str(root.models.heat_pump.outside_temperature) + ' ºC'
        size_hint: (0.1, 0.1)
        pos_hint: {'x': 0.75, 'y': 0.60}
        valign: 'middle'

    EHLabel:
        is_stale: root.models.mvhr.stale
        text: str(root.models.mvhr.outdoor_temperature) + ' ºC ' + str(root.models.mvhr.outdoor_humidity) + ' %'
        size_hint: (0.005, 0.005)
        pos_hint: {'x': 0.32, 'y': 0.67}
        halign: 'center'
        valign: 'middle'
    Arrow:
        arrow_at_midpoint: False
        shaft_width: cm(0.04)
        o_x: self.parent.width * 0.40
        o_y: self.parent.height * 0.655
        distance: self.parent.height * 0.035
        angle: 290
        head_size: CurrentStatus.calculate_arrow_size(3000)
    EHLabel:
        is_stale: root.models.mvhr.stale
        text: str(root.models.mvhr.supply_temperature) + ' ºC\n' + str(root.models.mvhr.supply_humidity) + ' %'
        size_hint: (0.005, 0.005)
        pos_hint: {'x': 0.42, 'y': 0.58}
        valign: 'middle'
        halign: 'center'

    EHLabel:
        is_stale: root.models.mvhr.stale
        text: str(root.models.mvhr.exhaust_temperature) + ' ºC ' + str(root.models.mvhr.exhaust_humidity) + ' %'
        size_hint: (0.005, 0.005)
        pos_hint: {'x': 0.62, 'y': 0.67}
        valign: 'middle'
        halign: 'center'
    Arrow:
        arrow_at_midpoint: False
        shaft_width: cm(0.04)
        o_x: self.parent.width * 0.57
        o_y: self.parent.height * 0.625
        distance: self.parent.height * 0.035
        angle: 70
        head_size: CurrentStatus.calculate_arrow_size(3000)

    EHLabel:
        is_stale: root.models.mvhr.stale
        text: str(root.models.mvhr.extract_temperature) + ' ºC\n' + str(root.models.mvhr.extract_humidity) + ' %'
        size_hint: (0.005, 0.005)
        pos_hint: {'x': 0.58, 'y': 0.58}
        halign: 'center'
        valign: 'middle'

    Image:
        source: 'energyhub/resources/radiator.jpg'
        size_hint: (0.35, 0.35)
        pos_hint: {'x': 0.001, 'y': 0.25}
    EHLabel:
        is_stale: root.models.heat_pump.stale
        text: str(root.models.heat_pump.heating_buffer_actual_temperature) + ' (' + str(root.models.heat_pump.heating_buffer_setpoint_temperature) + ') ºC'
        size_hint: (0.35, 0.005)
        pos_hint: {'x': 0.001, 'y': 0.36}
        valign: 'middle'
        halign: 'center'
    PowerArrow:
        active_color: root.models.solar.load_color
        # from House to first branches
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.5
        distance: self.parent.height * 0.1
        angle: 270
        power: root.models.solar.load
    Image:
        source: 'energyhub/resources/shower.png'
        size_hint: (0.2, 0.2)
        pos_hint: {'x': 0.05, 'y': 0.2}
    EHLabel:
        is_stale: root.models.heat_pump.stale
        text: str(root.models.heat_pump.dhw_actual_temperature) + ' (' + str(root.models.heat_pump.dhw_setpoint_temperature) + ') ºC'
        size_hint: (0.35, 0.005)
        pos_hint: {'x': 0.001, 'y': 0.24}
        valign: 'middle'
        halign: 'center'

    LabeledArrow:
        # first left branch
        is_stale: root.models.heat_pump.stale
        active_color: root.models.solar.load_color
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.4
        distance: self.parent.width * 0.2
        angle: 180
        power: root.models.heat_pump.heating_power
    Image:
        source: 'energyhub/resources/light-bulb-2-256.png'
        size_hint: (0.2, 0.2)
        pos_hint: {'x': 0.75, 'y': 0.32}
    LabeledArrow:
        # first right branch
        is_stale: root.models.solar.stale
        active_color: root.models.solar.load_color
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.4
        distance: self.parent.width * 0.2
        angle: 0
        power: root.models.remaining_load
    PowerArrow:
        # from first branches to second branches
        active_color: root.models.solar.load_color
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.4
        distance: self.parent.height * 0.1
        angle: 270
        power: root.models._bottom_arms_power
    LabeledArrow:
        is_stale: root.models.heat_pump.stale
        active_color: root.models.solar.load_color
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.3
        distance: self.parent.width * 0.2
        angle: 180
        power: root.models.heat_pump.dhw_power
    LabeledArrow:
        is_stale: root.models.diverter.stale
        active_color: root.models.solar.load_color
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.3
        distance: self.parent.width * 0.2
        angle: 0
        power: root.models.diverter.immersion_power
    Image:
        source: 'energyhub/resources/immersion-heater.png'
        size_hint: (0.2, 0.2)
        pos_hint: {'x': 0.75, 'y': 0.2}
    LabeledArrow:
        # to car load
        is_stale: root.models.diverter.stale
        active_color: root.models.solar.load_color
        o_x: self.parent.width * 0.5
        o_y: self.parent.height * 0.3
        distance: self.parent.height * 0.1
        angle: 270
        power: root.models.diverter.car_charger_power
    Image:
        source: 'energyhub/resources/ipace.jpg'
        size_hint: (0.5, 0.3)
        allow_stretch: False
        pos_hint: {'x': 0.25, 'y': 0.0}
    EHLabel:
        is_stale: root.models.car.stale
        text: root.models.car.charge_label
        pos_hint: {'y': 0.02, 'x': 0.45}
        size_hint: (0.1, 0.05)

<CurrentStatusContainer@RefreshOnScrollContainer>
    on_scroll_y: status_panel.check_pull_refresh(self)
    id: status_container
    CurrentStatus:
        id: status_panel
        height: root.height*1.01
        size_hint_y: None
